image: instrumentisto/flutter:3.29.0

stages:
  - build

cache:
  key: flutter-cache
  policy: pull-push
  paths:
    - .pub-cache

before_script:
  - apt-get update && apt-get install -y openjdk-17-jdk
  - export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
  - echo "org.gradle.java.home=$JAVA_HOME" > android/gradle.properties
  - echo "android.useAndroidX=true" >> android/gradle.properties
  - echo "android.enableJetifier=true" >> android/gradle.properties
  - echo "org.gradle.jvmargs=-Xmx2048m" >> android/gradle.properties
  - flutter pub get

build-debug:
  stage: build
  script:
    - flutter build apk --debug
  artifacts:
    paths:
      - build/app/outputs/flutter-apk/app-debug.apk
    expire_in: 1 week
  only:
    - dev
  when: manual
  tags:
    - stage-docker

build-release:
  stage: build
  script:
    - flutter build appbundle --release
  artifacts:
    paths:
      - build/app/outputs/bundle/release/app-release.aab
    expire_in: 1 week
  only:
    - release
  when: manual
  tags:
    - stage-docker